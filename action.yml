name: 'UniVPN Docker Action'
description: 'Setup UniVPN connection in GitHub Actions using Docker container'
author: 'borealin'

branding:
  icon: 'shield'
  color: 'blue'

inputs:
  server:
    description: 'UniVPN server address'
    required: true
  username:
    description: 'UniVPN username'
    required: true
  password:
    description: 'UniVPN password'
    required: true
  port:
    description: 'UniVPN server port'
    required: false
    default: '443'
  timeout:
    description: 'Connection timeout in seconds'
    required: false
    default: '60'

outputs:
  vpn-ip:
    description: 'VPN IP address assigned to the connection'
    value: ${{ steps.connect.outputs.vpn-ip }}
  status:
    description: 'VPN connection status'
    value: ${{ steps.connect.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Setup VPN Connection
      id: connect
      shell: bash
      run: |
        echo "ðŸ”Œ Establishing UniVPN connection..."
        echo "Server: ${{ inputs.server }}:${{ inputs.port }}"
        echo "Username: ${{ inputs.username }}"
        
        # è¿žæŽ¥ VPN
        if /app/univpn-wrapper.sh connect "${{ inputs.server }}" "${{ inputs.username }}" "${{ inputs.password }}" "${{ inputs.port }}"; then
          echo "âœ… VPN connection established successfully"
          
          # èŽ·å– VPN IP åœ°å€
          VPN_IP=$(ip addr show cnem_vnic 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d'/' -f1 || echo "unknown")
          echo "vpn-ip=$VPN_IP" >> $GITHUB_OUTPUT
          echo "status=connected" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
          echo "ðŸ“¡ Network interfaces:"
          ip addr show | grep -E "inet.*(tun|ppp|vpn|cnem_vnic|vnic)" || echo "No VPN interfaces found yet"
          
          # æ˜¾ç¤ºå½“å‰ IP
          echo "ðŸŒ Current external IP:"
          EXTERNAL_IP=$(curl -s --max-time 10 https://ipinfo.io/ip || echo "unknown")
          echo "External IP: $EXTERNAL_IP"
          
          # è®¾ç½®æ¸…ç†é™·é˜±
          echo "Setting up cleanup trap..."
          trap '/app/univpn-wrapper.sh disconnect || true' EXIT
          
        else
          echo "âŒ Failed to establish VPN connection"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Register cleanup
      shell: bash
      run: |
        echo "ðŸ“ VPN connection registered. Will cleanup on job completion."
        # æ³¨å†Œä¸€ä¸ªåŽç»­æ¸…ç†æ­¥éª¤çš„æ ‡è®°
        echo "VPN_CLEANUP_NEEDED=true" >> $GITHUB_ENV